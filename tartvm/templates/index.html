{% extends "base.html" %}

{% block title %}de taartenfabriek{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex justify-between items-center">
        <h2 class="text-2xl font-bold text-gray-900">Virtual Machines</h2>
        <div class="space-x-2">
            <button id="refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
            <button id="settings-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-cog mr-1"></i> Settings
            </button>
            <button id="create-vm-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-plus mr-1"></i> Create VM
            </button>
            <button id="pull-vm-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                <i class="fas fa-download mr-1"></i> Pull VM
            </button>
        </div>
    </div>

    <!-- Active Operations Panel -->
    <div id="active-tasks-panel" class="mt-6 hidden">
        <div class="bg-white shadow rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-tasks mr-2"></i>Active Operations
                    <span id="active-tasks-count" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        0
                    </span>
                </h3>
            </div>
            <div id="active-tasks-list" class="space-y-2">
                <!-- Active tasks will be rendered here -->
            </div>
        </div>
    </div>

    <div class="mt-4 flex items-center justify-between">
        <div class="inline-flex rounded-md shadow-sm" role="group">
            <button id="view-cards-btn" type="button" class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-l-md bg-white text-gray-700 hover:bg-gray-50">
                Cards
            </button>
            <button id="view-list-btn" type="button" class="px-3 py-2 text-sm font-medium border border-gray-300 rounded-r-md bg-white text-gray-700 hover:bg-gray-50">
                List
            </button>
        </div>
    </div>

    <!-- Loading State -->
    <div id="vms-loading" class="mt-6 p-8 text-center bg-white shadow rounded-lg">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-2 text-gray-600">Loading VMs...</p>
    </div>

    <!-- Empty State -->
    <div id="vms-empty" class="hidden mt-6 p-8 text-center bg-white shadow rounded-lg">
        <i class="fas fa-server text-4xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900">No VMs found</h3>
        <p class="mt-1 text-sm text-gray-500">Get started by pulling a VM image.</p>
        <div class="mt-6">
            <button id="pull-vm-empty-btn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <i class="fas fa-download mr-2"></i> Pull VM
            </button>
        </div>
    </div>

    <!-- Base Images Section -->
    <div id="base-images-section" class="mt-6 hidden">
        <div class="bg-white shadow rounded-lg border-2 border-indigo-100">
            <div class="px-6 py-4 border-b border-indigo-200 bg-indigo-50 flex items-center justify-between cursor-pointer hover:bg-indigo-100" id="base-images-toggle">
                <div class="flex items-center">
                    <i class="fas fa-box-open text-indigo-600 mr-3 text-lg"></i>
                    <h3 class="text-lg font-semibold text-gray-900">OCI Images</h3>
                    <span class="ml-3 text-sm text-gray-600">(Pulled from Registry)</span>
                    <span id="base-images-count" class="ml-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-200 text-indigo-900">
                        0
                    </span>
                </div>
                <i id="base-images-chevron" class="fas fa-chevron-down text-indigo-600 transition-transform duration-200"></i>
            </div>
            <div id="base-images-content" class="transition-all duration-200">
                <div id="base-images-table" class="hidden overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Source</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">VNC</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="base-images-list" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div id="base-images-cards" class="hidden p-6">
                    <div id="base-images-cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </div>
                <div id="base-images-empty" class="p-6 text-center text-gray-500">
                    No base images found. Pull an image to get started.
                </div>
            </div>
        </div>
    </div>

    <!-- Working VMs Section -->
    <div id="working-vms-section" class="mt-6 hidden">
        <div class="bg-white shadow rounded-lg border-2 border-green-100">
            <div class="px-6 py-4 border-b border-green-200 bg-green-50 flex items-center">
                <i class="fas fa-laptop-code text-green-600 mr-3 text-lg"></i>
                <h3 class="text-lg font-semibold text-gray-900">Local VMs</h3>
                <span class="ml-3 text-sm text-gray-600">(Cloned & Custom VMs)</span>
            </div>
            <div id="working-vms-table" class="hidden overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">VNC</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-20">CPU</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Memory</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="working-vms-list" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <div id="working-vms-cards" class="hidden p-6">
                <div id="working-vms-cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
            </div>
            <div id="working-vms-empty" class="p-6 text-center text-gray-500">
                No working VMs. Clone a base image to create one.
            </div>
        </div>
    </div>
</div>

<!-- Pull VM Modal -->
<div id="pull-vm-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-download text-indigo-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Pull VM Image</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">
                                Select a macOS image from the list or enter a custom OCI URL
                            </p>

                            <!-- Image Selection Tabs -->
                            <div class="mt-4">
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                        <button id="tab-select" type="button" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                            Select Image
                                        </button>
                                        <button id="tab-custom" type="button" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                                            Custom URL
                                        </button>
                                    </nav>
                                </div>
                            </div>

                            <!-- Select Image Panel -->
                            <div id="panel-select" class="mt-4 hidden">
                                <div id="images-loading" class="text-center py-4">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600 mx-auto"></div>
                                    <p class="mt-2 text-sm text-gray-500">Loading available images...</p>
                                </div>
                                <div id="images-loaded" class="hidden">
                                    <label for="image-select" class="block text-sm font-medium text-gray-700">Available macOS Images</label>
                                    <select id="image-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        <option value="">-- Select an image --</option>
                                    </select>
                                    <div id="image-tags" class="mt-3 hidden">
                                        <label for="tag-select" class="block text-sm font-medium text-gray-700">Version/Tag</label>
                                        <select id="tag-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                                        </select>
                                    </div>
                                    <div id="image-info" class="mt-3 hidden text-sm text-gray-600">
                                        <p><strong>Full URL:</strong> <code id="image-url-preview" class="bg-gray-100 px-2 py-1 rounded"></code></p>
                                    </div>
                                </div>
                                <div id="images-error" class="hidden text-sm mt-2">
                                    <!-- Error message will be shown here -->
                                </div>
                            </div>

                            <!-- Custom URL Panel -->
                            <div id="panel-custom" class="mt-4 hidden">
                                <label for="oci-url" class="block text-sm font-medium text-gray-700">OCI URL</label>
                                <input type="text" id="oci-url" class="mt-1 shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" placeholder="ghcr.io/cirruslabs/macos-ventura-base:latest">
                                <p class="mt-1 text-xs text-gray-500">Enter the full OCI URL of the VM image to pull</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="pull-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Pull
                </button>
                <button type="button" id="pull-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-gray-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-cog text-gray-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Settings</h3>
                        <div class="mt-4">
                            <div class="border-b border-gray-200 pb-4 mb-4">
                                <h4 class="text-sm font-medium text-gray-900 mb-2">GitHub API Token</h4>
                                <p class="text-sm text-gray-500 mb-3">
                                    A GitHub personal access token is <strong>required</strong> to fetch the latest available macOS images from Cirrus Labs dynamically.
                                    <a href="https://github.com/settings/tokens" target="_blank" class="text-indigo-600 hover:text-indigo-800">
                                        Create token <i class="fas fa-external-link-alt text-xs"></i>
                                    </a>
                                </p>
                                <div class="mb-3">
                                    <label for="github-token" class="block text-sm font-medium text-gray-700 mb-1">Personal Access Token</label>
                                    <input type="password" id="github-token" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                                    <p class="mt-1 text-xs text-gray-500">Required scope: <code class="bg-gray-100 px-1 rounded">read:packages</code></p>
                                </div>
                                <div id="token-status" class="text-sm hidden">
                                    <!-- Token status will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="settings-save-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Save
                </button>
                <button type="button" id="settings-clear-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Clear Token
                </button>
                <button type="button" id="settings-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Clone VM Modal -->
<div id="clone-vm-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-clone text-blue-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Clone VM</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 mb-4">
                                Create a copy of <strong id="clone-source-name"></strong>
                            </p>

                            <div class="mb-4">
                                <label for="clone-new-name" class="block text-sm font-medium text-gray-700 mb-1">New VM Name</label>
                                <input type="text" id="clone-new-name" class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" placeholder="my-vm-copy">
                            </div>

                            <div class="border-t border-gray-200 pt-4">
                                <label class="flex items-start cursor-pointer">
                                    <input type="checkbox" id="clone-and-start-vnc" class="mt-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-3">
                                        <span class="block text-sm font-medium text-gray-900">Start with VNC after cloning</span>
                                        <span class="block text-xs text-gray-500 mt-1">
                                            Automatically starts the cloned VM in VNC mode (--vnc --no-graphics) and provides a clickable vnc:// link
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="clone-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Clone
                </button>
                <button type="button" id="clone-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create VM Modal -->
<div id="create-vm-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-plus text-green-600"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900">Create New VM from Existing OCI Image</h3>
                        <div class="mt-4">
                            <div class="mb-4">
                                <label for="create-vm-image" class="block text-sm font-medium text-gray-700 mb-1">Base Image</label>
                                <select id="create-vm-image" class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border">
                                    <option value="">-- Select an image --</option>
                                </select>
                                <p class="mt-1 text-xs text-gray-500">Select from your already-pulled OCI images</p>
                                <div id="create-vm-loading" class="mt-2 text-sm text-gray-500 hidden">
                                    <i class="fas fa-spinner fa-spin mr-1"></i> Loading images...
                                </div>
                                <div id="create-vm-no-images" class="mt-2 text-sm text-amber-600 hidden">
                                    <i class="fas fa-info-circle mr-1"></i> No OCI images found. Pull an image first using "Pull VM" button.
                                </div>
                            </div>

                            <div class="mb-4">
                                <label for="create-vm-name" class="block text-sm font-medium text-gray-700 mb-1">VM Name</label>
                                <input type="text" id="create-vm-name" class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" placeholder="my-custom-vm">
                                <p class="mt-1 text-xs text-gray-500">A unique name for your local VM</p>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label for="create-vm-cpu" class="block text-sm font-medium text-gray-700 mb-1">CPU Cores</label>
                                    <input type="number" id="create-vm-cpu" class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" value="4" min="1" max="32">
                                </div>
                                <div>
                                    <label for="create-vm-memory" class="block text-sm font-medium text-gray-700 mb-1">Memory (GB)</label>
                                    <input type="number" id="create-vm-memory" class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" value="8" min="1" max="128">
                                </div>
                                <div>
                                    <label for="create-vm-disk" class="block text-sm font-medium text-gray-700 mb-1">Disk (GB)</label>
                                    <input type="number" id="create-vm-disk" class="shadow-sm focus:ring-green-500 focus:border-green-500 block w-full sm:text-sm border-gray-300 rounded-md p-2 border" value="50" min="10" max="500">
                                </div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-md p-3 text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i> The VM will be cloned from the selected OCI image and configured with your custom resources.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="create-vm-confirm-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Create
                </button>
                <button type="button" id="create-vm-cancel-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Logs Modal -->
<div id="task-logs-modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="task-title">Task Logs</h3>
                            <div id="task-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                                <!-- Status badge will be inserted here -->
                            </div>
                        </div>
                        <div class="mt-4">
                            <div id="task-logs" class="bg-black text-green-400 font-mono text-sm p-4 rounded-md h-96 overflow-y-auto">
                                <div class="text-gray-500">Waiting for logs...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="close-logs-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentTaskId = null;
    let taskSocket = null;
    let lastVMs = null;
    let currentView = 'cards';
    const VIEW_STORAGE_KEY = 'de-taartenfabriek:vmView';
    const vmConfigCache = new Map();
    let availableImages = [];
    let currentPullMode = 'select'; // 'select' or 'custom'

    const AUTO_REFRESH_MS = 10000;
    let autoRefreshTimer = null;
    let autoRefreshInFlight = false;

    // Active tasks tracking
    const ACTIVE_TASKS_REFRESH_MS = 3000;
    let activeTasksTimer = null;
    let activeTasksInFlight = false;

    // DOM elements
    const vmsLoading = document.getElementById('vms-loading');
    const vmsEmpty = document.getElementById('vms-empty');

    // Base Images elements
    const baseImagesSection = document.getElementById('base-images-section');
    const baseImagesToggle = document.getElementById('base-images-toggle');
    const baseImagesContent = document.getElementById('base-images-content');
    const baseImagesChevron = document.getElementById('base-images-chevron');
    const baseImagesCount = document.getElementById('base-images-count');
    const baseImagesTable = document.getElementById('base-images-table');
    const baseImagesList = document.getElementById('base-images-list');
    const baseImagesCards = document.getElementById('base-images-cards');
    const baseImagesCardsGrid = document.getElementById('base-images-cards-grid');
    const baseImagesEmpty = document.getElementById('base-images-empty');

    // Base images collapse state
    let baseImagesExpanded = true;

    // Working VMs elements
    const workingVmsSection = document.getElementById('working-vms-section');
    const workingVmsTable = document.getElementById('working-vms-table');
    const workingVmsList = document.getElementById('working-vms-list');
    const workingVmsCards = document.getElementById('working-vms-cards');
    const workingVmsCardsGrid = document.getElementById('working-vms-cards-grid');
    const workingVmsEmpty = document.getElementById('working-vms-empty');

    const viewCardsBtn = document.getElementById('view-cards-btn');
    const viewListBtn = document.getElementById('view-list-btn');

    // Pull VM modal tabs
    const tabSelect = document.getElementById('tab-select');
    const tabCustom = document.getElementById('tab-custom');
    const panelSelect = document.getElementById('panel-select');
    const panelCustom = document.getElementById('panel-custom');
    const imageSelect = document.getElementById('image-select');
    const tagSelect = document.getElementById('tag-select');
    const imageTags = document.getElementById('image-tags');
    const imageInfo = document.getElementById('image-info');
    const imageUrlPreview = document.getElementById('image-url-preview');
    const imagesLoading = document.getElementById('images-loading');
    const imagesLoaded = document.getElementById('images-loaded');
    const imagesError = document.getElementById('images-error');

    // Active tasks panel elements
    const activeTasksPanel = document.getElementById('active-tasks-panel');
    const activeTasksList = document.getElementById('active-tasks-list');
    const activeTasksCount = document.getElementById('active-tasks-count');
    
    // Modal elements
    const pullVmModal = document.getElementById('pull-vm-modal');
    const pullVmBtn = document.getElementById('pull-vm-btn');
    const pullVmEmptyBtn = document.getElementById('pull-vm-empty-btn');
    const pullConfirmBtn = document.getElementById('pull-confirm-btn');
    const pullCancelBtn = document.getElementById('pull-cancel-btn');
    const ociUrlInput = document.getElementById('oci-url');

    const settingsModal = document.getElementById('settings-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsSaveBtn = document.getElementById('settings-save-btn');
    const settingsClearBtn = document.getElementById('settings-clear-btn');
    const settingsCancelBtn = document.getElementById('settings-cancel-btn');
    const githubTokenInput = document.getElementById('github-token');
    const tokenStatus = document.getElementById('token-status');

    const cloneVmModal = document.getElementById('clone-vm-modal');
    const cloneSourceName = document.getElementById('clone-source-name');
    const cloneNewNameInput = document.getElementById('clone-new-name');
    const cloneAndStartVncCheckbox = document.getElementById('clone-and-start-vnc');
    const cloneConfirmBtn = document.getElementById('clone-confirm-btn');
    const cloneCancelBtn = document.getElementById('clone-cancel-btn');

    const taskLogsModal = document.getElementById('task-logs-modal');
    const taskTitle = document.getElementById('task-title');
    const taskStatus = document.getElementById('task-status');
    const taskLogs = document.getElementById('task-logs');
    const closeLogsBtn = document.getElementById('close-logs-btn');

    const createVmModal = document.getElementById('create-vm-modal');
    const createVmBtn = document.getElementById('create-vm-btn');
    const createVmConfirmBtn = document.getElementById('create-vm-confirm-btn');
    const createVmCancelBtn = document.getElementById('create-vm-cancel-btn');
    const createVmImageSelect = document.getElementById('create-vm-image');
    const createVmLoading = document.getElementById('create-vm-loading');
    const createVmNoImages = document.getElementById('create-vm-no-images');
    const createVmNameInput = document.getElementById('create-vm-name');
    const createVmCpuInput = document.getElementById('create-vm-cpu');
    const createVmMemoryInput = document.getElementById('create-vm-memory');
    const createVmDiskInput = document.getElementById('create-vm-disk');

    let createVmPulledImages = [];

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const storedView = window.localStorage.getItem(VIEW_STORAGE_KEY);
        if (storedView === 'list' || storedView === 'cards') {
            currentView = storedView;
        }
        updateViewToggle();

        // Load VMs on page load
        loadVMsCached();

        // Silent auto-refresh (keeps UI in sync with backend monitoring)
        startAutoRefresh();
        startActiveTasksPolling();

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
                stopActiveTasksPolling();
            } else {
                startAutoRefresh();
                startActiveTasksPolling();
                loadVMsSilent();
                refreshActiveTasks();
            }
        });

        // Set up event listeners
        document.getElementById('refresh-btn').addEventListener('click', loadVMs);

        // Event delegation for VM action buttons
        document.body.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button || button.disabled) return;

            const action = button.getAttribute('data-action');
            const vmElement = button.closest('[data-vm]');
            if (!vmElement) return;

            const vmName = vmElement.dataset.vm;
            if (vmName && action) {
                handleVmAction(vmName, action);
            }
        });

        viewCardsBtn.addEventListener('click', () => setView('cards'));
        viewListBtn.addEventListener('click', () => setView('list'));

        // Base images expand/collapse
        baseImagesToggle.addEventListener('click', toggleBaseImagesSection);

        // Pull VM modal
        pullVmBtn.addEventListener('click', () => {
            showModal(pullVmModal);
            loadAvailableImages();
        });
        pullVmEmptyBtn.addEventListener('click', () => {
            showModal(pullVmModal);
            loadAvailableImages();
        });
        pullCancelBtn.addEventListener('click', () => hideModal(pullVmModal));
        pullConfirmBtn.addEventListener('click', handlePullVm);

        // Pull VM tabs
        tabSelect.addEventListener('click', () => switchPullTab('select'));
        tabCustom.addEventListener('click', () => switchPullTab('custom'));

        // Image selection
        imageSelect.addEventListener('change', handleImageSelection);
        tagSelect.addEventListener('change', updateImageUrlPreview);

        // Settings modal
        settingsBtn.addEventListener('click', () => {
            showModal(settingsModal);
            loadGitHubTokenStatus();
        });
        settingsCancelBtn.addEventListener('click', () => hideModal(settingsModal));
        settingsSaveBtn.addEventListener('click', handleSaveGitHubToken);
        settingsClearBtn.addEventListener('click', handleClearGitHubToken);

        // Create VM modal
        createVmBtn.addEventListener('click', () => {
            createVmNameInput.value = '';
            createVmImageSelect.value = '';
            createVmCpuInput.value = '4';
            createVmMemoryInput.value = '8';
            createVmDiskInput.value = '50';
            showModal(createVmModal);
            loadCreateVmImages();
        });
        createVmCancelBtn.addEventListener('click', () => hideModal(createVmModal));
        createVmConfirmBtn.addEventListener('click', handleCreateVm);

        // Clone modal
        cloneCancelBtn.addEventListener('click', () => hideModal(cloneVmModal));
        cloneConfirmBtn.addEventListener('click', handleCloneConfirm);

        // Task logs modal
        closeLogsBtn.addEventListener('click', () => {
            hideModal(taskLogsModal);
            if (taskSocket) {
                taskSocket.close();
                taskSocket = null;
            }
            loadVMsCached();
            refreshActiveTasks();
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === pullVmModal) hideModal(pullVmModal);
            if (e.target === settingsModal) hideModal(settingsModal);
            if (e.target === cloneVmModal) hideModal(cloneVmModal);
            if (e.target === taskLogsModal) {
                hideModal(taskLogsModal);
                if (taskSocket) {
                    taskSocket.close();
                    taskSocket = null;
                }
                loadVMsCached();
                refreshActiveTasks();
            }
        });
    });

    function startAutoRefresh() {
        if (autoRefreshTimer) return;
        autoRefreshTimer = window.setInterval(() => {
            if (document.hidden) return;
            loadVMsSilent();
        }, AUTO_REFRESH_MS);
    }

    function stopAutoRefresh() {
        if (!autoRefreshTimer) return;
        window.clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }

    // Active tasks polling functions
    function startActiveTasksPolling() {
        if (activeTasksTimer) return;
        refreshActiveTasks(); // Initial load
        activeTasksTimer = window.setInterval(() => {
            if (document.hidden) return;
            refreshActiveTasks();
        }, ACTIVE_TASKS_REFRESH_MS);
    }

    function stopActiveTasksPolling() {
        if (!activeTasksTimer) return;
        window.clearInterval(activeTasksTimer);
        activeTasksTimer = null;
    }

    async function refreshActiveTasks() {
        if (activeTasksInFlight) return;
        activeTasksInFlight = true;
        try {
            const tasks = await api.get('/api/tasks/active');
            renderActiveTasks(tasks);
        } catch (error) {
            console.warn('Failed to fetch active tasks:', error);
        } finally {
            activeTasksInFlight = false;
        }
    }

    function renderActiveTasks(tasks) {
        if (!tasks || tasks.length === 0) {
            activeTasksPanel.classList.add('hidden');
            return;
        }

        activeTasksPanel.classList.remove('hidden');
        activeTasksCount.textContent = tasks.length;

        activeTasksList.innerHTML = tasks.map(task => {
            const actionText = formatTaskAction(task);
            const timeAgo = formatTimeAgo(task.created_at);
            const lastLog = task.logs && task.logs.length > 0
                ? task.logs[task.logs.length - 1]
                : 'Starting...';

            // Use full class names for Tailwind CSS JIT compilation
            const bgClass = task.status === 'running' ? 'bg-blue-50' : 'bg-yellow-50';
            const borderClass = task.status === 'running' ? 'border-blue-200' : 'border-yellow-200';
            const spinnerClass = task.status === 'running' ? 'border-blue-600' : 'border-yellow-600';

            return `
                <div class="${bgClass} border ${borderClass} rounded-lg p-3">
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 ${spinnerClass}"></div>
                                <div class="font-medium text-sm text-gray-900">${escapeHtml(actionText)}</div>
                            </div>
                            <div class="text-xs text-gray-600 mt-1">
                                Started ${timeAgo}
                            </div>
                            ${lastLog ? `
                                <div class="text-xs text-gray-500 mt-2 font-mono bg-black bg-opacity-5 px-2 py-1 rounded truncate">
                                    ${escapeHtml(lastLog)}
                                </div>
                            ` : ''}
                        </div>
                        <button onclick="showTaskLogs('${task.id}', '${escapeHtml(actionText)}')"
                                class="ml-3 flex-shrink-0 text-indigo-600 hover:text-indigo-800 text-sm font-medium">
                            View Logs
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function formatTaskAction(task) {
        const action = task.action || 'task';
        const vmName = task.vm_name || '';
        const ociUrl = task.oci_url || '';

        switch (action) {
            case 'start_vm':
                return `Starting VM: ${vmName}`;
            case 'stop_vm':
                return `Stopping VM: ${vmName}`;
            case 'delete_vm':
                return `Deleting VM: ${vmName}`;
            case 'pull_vm':
                return `Pulling VM: ${ociUrl}`;
            case 'clone_vm':
                return `Cloning VM: ${vmName}`;
            default:
                return action;
        }
    }

    function formatTimeAgo(timestamp) {
        const now = Date.now() / 1000;
        const diff = now - timestamp;

        if (diff < 60) {
            return `${Math.floor(diff)}s ago`;
        } else if (diff < 3600) {
            return `${Math.floor(diff / 60)}m ago`;
        } else if (diff < 86400) {
            return `${Math.floor(diff / 3600)}h ago`;
        } else {
            return `${Math.floor(diff / 86400)}d ago`;
        }
    }

    async function loadVMsSilent() {
        if (autoRefreshInFlight) return;
        autoRefreshInFlight = true;
        try {
            const data = await api.get('/api/vms/categorized');
            lastVMs = data;
            renderCategorizedVMs(data);
        } catch (error) {
            console.warn('Silent VM refresh failed:', error);
        } finally {
            autoRefreshInFlight = false;
        }
    }

    async function loadVMsCached() {
        try {
            showLoading();
            const data = await api.get('/api/vms/categorized');
            lastVMs = data;
            renderCategorizedVMs(data);
        } catch (error) {
            console.error('Error loading VMs:', error);
            showToast('Failed to load VMs', 'error');
        } finally {
            hideLoading();
        }
    }
    
    // Functions
    async function loadVMs() {
        try {
            showLoading();
            await api.post('/api/vms/refresh', {});
            const data = await api.get('/api/vms/categorized');
            lastVMs = data;
            renderCategorizedVMs(data);
        } catch (error) {
            console.error('Error loading VMs:', error);
            showToast('Failed to load VMs', 'error');
        } finally {
            hideLoading();
        }
    }

    function toggleBaseImagesSection() {
        baseImagesExpanded = !baseImagesExpanded;

        if (baseImagesExpanded) {
            baseImagesContent.classList.remove('hidden');
            baseImagesChevron.classList.remove('fa-chevron-right');
            baseImagesChevron.classList.add('fa-chevron-down');
        } else {
            baseImagesContent.classList.add('hidden');
            baseImagesChevron.classList.remove('fa-chevron-down');
            baseImagesChevron.classList.add('fa-chevron-right');
        }
    }

    function renderCategorizedVMs(data) {
        const totalVMs = (data.base_images?.length || 0) + (data.working_vms?.length || 0);

        if (totalVMs === 0) {
            baseImagesSection.classList.add('hidden');
            workingVmsSection.classList.add('hidden');
            vmsEmpty.classList.remove('hidden');
            return;
        }

        vmsEmpty.classList.add('hidden');

        // Render base images
        if (data.base_images && data.base_images.length > 0) {
            baseImagesSection.classList.remove('hidden');
            baseImagesCount.textContent = data.base_images.length;
            if (currentView === 'list') {
                renderBaseImagesTable(data.base_images);
            } else {
                renderBaseImagesCards(data.base_images);
            }
        } else {
            baseImagesSection.classList.add('hidden');
        }

        // Render working VMs
        if (data.working_vms && data.working_vms.length > 0) {
            workingVmsSection.classList.remove('hidden');
            if (currentView === 'list') {
                renderWorkingVMsTable(data.working_vms);
            } else {
                renderWorkingVMsCards(data.working_vms);
            }
        } else {
            workingVmsSection.classList.add('hidden');
        }
    }

    function getStatusBadge(vm) {
        if (vm.status === 'running') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Running</span>';
        }
        if (vm.status === 'stopped') {
            return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Stopped</span>';
        }
        return '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Unknown</span>';
    }

    function renderBaseImagesTable(vms) {
        baseImagesList.innerHTML = '';

        if (!vms || vms.length === 0) {
            baseImagesTable.classList.add('hidden');
            baseImagesCards.classList.add('hidden');
            baseImagesEmpty.classList.remove('hidden');
            return;
        }

        vms.forEach(vm => {
            const row = document.createElement('tr');
            row.dataset.vm = vm.name;
            const statusBadge = getStatusBadge(vm);

            // For OCI images, create a clickable link to the source
            const isOCI = vm.source && vm.source.toUpperCase() === 'OCI';
            const sourceUrl = isOCI ? vm.name : (vm.source || '');
            const sourceDisplay = isOCI
                ? `<a href="#" class="text-indigo-600 hover:text-indigo-900 font-medium" onclick="navigator.clipboard.writeText('${escapeHtml(sourceUrl)}'); showToast('Source URL copied to clipboard', 'success'); return false;" title="Click to copy: ${escapeHtml(sourceUrl)}">Source <i class="fas fa-copy text-xs ml-1"></i></a>`
                : `<span class="text-gray-600">${escapeHtml(vm.source || 'Local')}</span>`;

            const actions = `
                <div class="flex justify-end space-x-2">
                    <button class="text-indigo-600 hover:text-indigo-900" title="Start" data-action="start" ${vm.status === 'running' ? 'disabled' : ''}>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-900" title="Stop" data-action="stop" ${vm.status !== 'running' ? 'disabled' : ''}>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="text-blue-600 hover:text-blue-900" title="Clone" data-action="clone">
                        <i class="fas fa-clone"></i>
                    </button>
                    <button class="text-gray-600 hover:text-gray-900" title="Delete" data-action="delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900 break-words">${escapeHtml(vm.name)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${statusBadge}
                </td>
                <td class="px-6 py-4 text-sm">
                    ${sourceDisplay}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${vm.ip_address ? `<a class="text-indigo-600 hover:text-indigo-900 font-mono text-xs" href="vnc://${vm.ip_address}">${vm.ip_address}</a>` : '<span class="text-gray-400">N/A</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${actions}
                </td>
            `;

            baseImagesList.appendChild(row);
        });

        baseImagesEmpty.classList.add('hidden');
        baseImagesCards.classList.add('hidden');
        baseImagesTable.classList.remove('hidden');
    }

    function renderBaseImagesCards(vms) {
        baseImagesCardsGrid.innerHTML = '';

        if (!vms || vms.length === 0) {
            baseImagesTable.classList.add('hidden');
            baseImagesCards.classList.add('hidden');
            baseImagesEmpty.classList.remove('hidden');
            return;
        }

        vms.forEach(vm => {
            const statusBadge = getStatusBadge(vm);
            const ipBlock = vm.ip_address
                ? `<a class="text-indigo-600 hover:text-indigo-900 font-mono" href="vnc://${vm.ip_address}">vnc://${vm.ip_address}</a>`
                : '<span class="text-gray-500">N/A</span>';

            // For OCI images, create a clickable link to the source
            const isOCI = vm.source && vm.source.toUpperCase() === 'OCI';
            const sourceUrl = isOCI ? vm.name : (vm.source || '');
            const sourceDisplay = isOCI
                ? `<a href="#" class="text-indigo-600 hover:text-indigo-900 font-medium" onclick="navigator.clipboard.writeText('${escapeHtml(sourceUrl)}'); showToast('Source URL copied to clipboard', 'success'); return false;" title="Click to copy: ${escapeHtml(sourceUrl)}"><i class="fas fa-box-open mr-1"></i>Source <i class="fas fa-copy text-xs ml-1"></i></a>`
                : `<span class="text-gray-600"><i class="fas fa-laptop-code mr-1"></i>${escapeHtml(vm.source || 'Local')}</span>`;

            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg shadow-sm';
            card.dataset.vm = vm.name;

            card.innerHTML = `
                <div class="px-4 py-3 border-b border-gray-100 flex items-start justify-between gap-3">
                    <div class="min-w-0 flex-1">
                        <div class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(vm.name)}</div>
                        <div class="mt-1">${statusBadge}</div>
                    </div>
                </div>
                <div class="px-4 py-4 space-y-3">
                    <div class="text-xs">
                        ${sourceDisplay}
                    </div>

                    <div class="text-sm">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wider">VNC</div>
                        <div class="mt-1">${ipBlock}</div>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-2">
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded" data-action="start" ${vm.status === 'running' ? 'disabled' : ''}>
                            <i class="fas fa-play mr-1"></i> Start
                        </button>
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded" data-action="stop" ${vm.status !== 'running' ? 'disabled' : ''}>
                            <i class="fas fa-stop mr-1"></i> Stop
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded" data-action="clone">
                            <i class="fas fa-clone mr-1"></i> Clone
                        </button>
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-gray-600 hover:bg-gray-700 rounded" data-action="delete">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            baseImagesCardsGrid.appendChild(card);
        });

        baseImagesEmpty.classList.add('hidden');
        baseImagesTable.classList.add('hidden');
        baseImagesCards.classList.remove('hidden');
    }

    function renderWorkingVMsTable(vms) {
        workingVmsList.innerHTML = '';

        if (!vms || vms.length === 0) {
            workingVmsTable.classList.add('hidden');
            workingVmsCards.classList.add('hidden');
            workingVmsEmpty.classList.remove('hidden');
            return;
        }

        vms.forEach(vm => {
            const row = document.createElement('tr');
            row.dataset.vm = vm.name;
            const statusBadge = getStatusBadge(vm);

            const actions = `
                <div class="flex justify-end space-x-2">
                    <button class="text-indigo-600 hover:text-indigo-900" title="Start" data-action="start" ${vm.status === 'running' ? 'disabled' : ''}>
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="text-red-600 hover:text-red-900" title="Stop" data-action="stop" ${vm.status !== 'running' ? 'disabled' : ''}>
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="text-blue-600 hover:text-blue-900" title="Clone" data-action="clone">
                        <i class="fas fa-clone"></i>
                    </button>
                    <button class="text-gray-600 hover:text-gray-900" title="Delete" data-action="delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            row.innerHTML = `
                <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900 break-words">${escapeHtml(vm.name)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${statusBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${vm.ip_address ? `<a class="text-indigo-600 hover:text-indigo-900 font-mono text-xs" href="vnc://${vm.ip_address}">${vm.ip_address}</a>` : '<span class="text-gray-400">N/A</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    ${vmConfigCache.get(vm.name)?.cpu || vm.cpu || '<span class="text-gray-400">N/A</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                    ${vmConfigCache.get(vm.name)?.memory || vm.memory || '<span class="text-gray-400">N/A</span>'}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    ${actions}
                </td>
            `;

            workingVmsList.appendChild(row);

            ensureVmConfigLoaded(vm.name);
        });

        workingVmsEmpty.classList.add('hidden');
        workingVmsCards.classList.add('hidden');
        workingVmsTable.classList.remove('hidden');
    }

    function renderWorkingVMsCards(vms) {
        workingVmsCardsGrid.innerHTML = '';

        if (!vms || vms.length === 0) {
            workingVmsTable.classList.add('hidden');
            workingVmsCards.classList.add('hidden');
            workingVmsEmpty.classList.remove('hidden');
            return;
        }

        vms.forEach(vm => {
            const statusBadge = getStatusBadge(vm);
            const ipBlock = vm.ip_address
                ? `<a class="text-indigo-600 hover:text-indigo-900 font-mono" href="vnc://${vm.ip_address}">vnc://${vm.ip_address}</a>`
                : '<span class="text-gray-500">N/A</span>';

            const cachedConfig = vmConfigCache.get(vm.name);
            const cpuText = (cachedConfig && cachedConfig.cpu) ? cachedConfig.cpu : (vm.cpu || 'Loading');
            const memText = (cachedConfig && cachedConfig.memory) ? cachedConfig.memory : (vm.memory || 'Loading');
            const diskText = (cachedConfig && cachedConfig.disk_size) ? cachedConfig.disk_size : 'Loading';

            const card = document.createElement('div');
            card.className = 'bg-white border border-gray-200 rounded-lg shadow-sm';
            card.dataset.vm = vm.name;

            card.innerHTML = `
                <div class="px-4 py-3 border-b border-gray-100 flex items-start justify-between gap-3">
                    <div class="min-w-0 flex-1">
                        <div class="text-sm font-semibold text-gray-900 truncate">${escapeHtml(vm.name)}</div>
                        <div class="mt-1">${statusBadge}</div>
                    </div>
                </div>
                <div class="px-4 py-4 space-y-3">
                    <div class="text-sm">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wider">VNC</div>
                        <div class="mt-1">${ipBlock}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-sm">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider">CPU</div>
                            <div class="mt-1 text-gray-900" data-field="cpu">${cpuText}</div>
                        </div>
                        <div class="text-sm">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider">Memory</div>
                            <div class="mt-1 text-gray-900" data-field="memory">${memText}</div>
                        </div>
                        <div class="text-sm">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wider">Disk</div>
                            <div class="mt-1 text-gray-900" data-field="disk">${diskText}</div>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-2 pt-2">
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded" data-action="start" ${vm.status === 'running' ? 'disabled' : ''}>
                            <i class="fas fa-play mr-1"></i> Start
                        </button>
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded" data-action="stop" ${vm.status !== 'running' ? 'disabled' : ''}>
                            <i class="fas fa-stop mr-1"></i> Stop
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded" data-action="clone">
                            <i class="fas fa-clone mr-1"></i> Clone
                        </button>
                        <button class="flex-1 px-3 py-1.5 text-xs font-medium text-white bg-gray-600 hover:bg-gray-700 rounded" data-action="delete">
                            <i class="fas fa-trash mr-1"></i> Delete
                        </button>
                    </div>
                </div>
            `;

            workingVmsCardsGrid.appendChild(card);

            ensureVmConfigLoaded(vm.name);
        });

        workingVmsEmpty.classList.add('hidden');
        workingVmsTable.classList.add('hidden');
        workingVmsCards.classList.remove('hidden');
    }

    function setView(view) {
        if (view !== 'cards' && view !== 'list') return;
        currentView = view;
        window.localStorage.setItem(VIEW_STORAGE_KEY, view);
        updateViewToggle();

        if (lastVMs) {
            renderCategorizedVMs(lastVMs);
        } else {
            loadVMsCached();
        }
    }

    function updateViewToggle() {
        const activeClasses = ['bg-indigo-600', 'text-white', 'border-indigo-600'];
        const inactiveClasses = ['bg-white', 'text-gray-700', 'border-gray-300'];

        const setButtonState = (btn, active) => {
            activeClasses.forEach(c => btn.classList.toggle(c, active));
            inactiveClasses.forEach(c => btn.classList.toggle(c, !active));
        };

        setButtonState(viewCardsBtn, currentView === 'cards');
        setButtonState(viewListBtn, currentView === 'list');
    }

    async function ensureVmConfigLoaded(vmName) {
        if (vmConfigCache.has(vmName)) {
            return;
        }

        try {
            const cfg = await api.get(`/api/vms/${encodeURIComponent(vmName)}/config`);
            vmConfigCache.set(vmName, cfg);

            // Re-render to show the loaded config
            if (lastVMs) {
                renderCategorizedVMs(lastVMs);
            }
        } catch (error) {
            // Best-effort: leave placeholders.
            console.warn('Failed to load VM config for', vmName, error);
        }
    }
    
    async function handleVmAction(vmName, action) {
        try {
            let endpoint = '';
            let actionText = '';

            switch (action) {
                case 'start':
                    endpoint = `/api/vms/${encodeURIComponent(vmName)}/start`;
                    actionText = 'Starting';
                    break;
                case 'stop':
                    endpoint = `/api/vms/${encodeURIComponent(vmName)}/stop`;
                    actionText = 'Stopping';
                    break;
                case 'delete':
                    if (!confirm(`Are you sure you want to delete ${vmName}? This action cannot be undone.`)) {
                        return;
                    }
                    endpoint = `/api/vms/${encodeURIComponent(vmName)}/delete`;
                    actionText = 'Deleting';
                    break;
                case 'clone':
                    showCloneModal(vmName, false);
                    return;
                default:
                    return;
            }

            showToast(`${actionText} VM ${vmName}...`, 'info');
            const task = await api.post(endpoint, {});
            showTaskLogs(task.id, `${actionText} VM ${vmName}`);

        } catch (error) {
            console.error(`Error ${action} VM:`, error);
            showToast(`Failed to ${action} VM ${vmName}`, 'error');
        }
    }
    
    async function loadGitHubTokenStatus() {
        try {
            const status = await api.get('/api/settings/github-token');

            // Clear the input field
            githubTokenInput.value = '';

            if (status.configured) {
                tokenStatus.className = 'text-sm text-green-600 bg-green-50 p-2 rounded';
                tokenStatus.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Token configured: ${escapeHtml(status.masked_token || 'Active')}`;
                tokenStatus.classList.remove('hidden');
            } else {
                tokenStatus.className = 'text-sm text-yellow-600 bg-yellow-50 p-2 rounded';
                tokenStatus.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> No token configured';
                tokenStatus.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Failed to load GitHub token status:', error);
            tokenStatus.className = 'text-sm text-red-600 bg-red-50 p-2 rounded';
            tokenStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-1"></i> Failed to load token status';
            tokenStatus.classList.remove('hidden');
        }
    }

    async function handleSaveGitHubToken() {
        const token = githubTokenInput.value.trim();

        if (!token) {
            showToast('Please enter a GitHub token', 'error');
            return;
        }

        try {
            const result = await api.post('/api/settings/github-token', { token });
            showToast(result.message || 'GitHub token saved successfully', 'success');
            hideModal(settingsModal);

            // Optionally reload available images if the Pull VM modal is open
            if (!pullVmModal.classList.contains('hidden')) {
                loadAvailableImages();
            }
        } catch (error) {
            console.error('Failed to save GitHub token:', error);
            showToast('Failed to save GitHub token', 'error');
        }
    }

    async function handleClearGitHubToken() {
        if (!confirm('Are you sure you want to clear the GitHub token?')) {
            return;
        }

        try {
            const result = await api.post('/api/settings/github-token', { token: null });
            showToast(result.message || 'GitHub token cleared successfully', 'success');
            githubTokenInput.value = '';
            loadGitHubTokenStatus();
        } catch (error) {
            console.error('Failed to clear GitHub token:', error);
            showToast('Failed to clear GitHub token', 'error');
        }
    }

    function showCloneModal(vmName, startWithVnc = false) {
        cloneSourceName.textContent = vmName;
        cloneNewNameInput.value = `${vmName}-clone`;
        cloneAndStartVncCheckbox.checked = startWithVnc;
        showModal(cloneVmModal);
    }

    async function handleCloneConfirm() {
        const sourceVM = cloneSourceName.textContent;
        const newName = cloneNewNameInput.value.trim();
        const startAfter = cloneAndStartVncCheckbox.checked;

        if (!newName) {
            showToast('Please enter a name for the cloned VM', 'error');
            return;
        }

        try {
            hideModal(cloneVmModal);

            const actionText = startAfter ? `Cloning ${sourceVM} to ${newName} and starting with VNC` : `Cloning ${sourceVM} to ${newName}`;
            showToast(actionText + '...', 'info');

            const task = await api.post(`/api/vms/${encodeURIComponent(sourceVM)}/clone`, {
                new_name: newName,
                start_after_clone: startAfter
            });

            const title = startAfter
                ? `Cloning & Starting VNC: ${sourceVM}  ${newName}`
                : `Cloning: ${sourceVM}  ${newName}`;

            showTaskLogs(task.id, title);

        } catch (error) {
            console.error('Error cloning VM:', error);
            showToast(`Failed to clone VM: ${error.message}`, 'error');
        }
    }

    function switchPullTab(mode) {
        currentPullMode = mode;

        // Update tab styles
        const activeClasses = ['border-indigo-500', 'text-indigo-600'];
        const inactiveClasses = ['border-transparent', 'text-gray-500'];

        if (mode === 'select') {
            tabSelect.classList.remove(...inactiveClasses);
            tabSelect.classList.add(...activeClasses);
            tabCustom.classList.remove(...activeClasses);
            tabCustom.classList.add(...inactiveClasses);
            panelSelect.classList.remove('hidden');
            panelCustom.classList.add('hidden');
        } else {
            tabCustom.classList.remove(...inactiveClasses);
            tabCustom.classList.add(...activeClasses);
            tabSelect.classList.remove(...activeClasses);
            tabSelect.classList.add(...inactiveClasses);
            panelCustom.classList.remove('hidden');
            panelSelect.classList.add('hidden');
        }
    }

    async function loadAvailableImages() {
        // Switch to select tab by default
        switchPullTab('select');

        // Show loading state
        imagesLoading.classList.remove('hidden');
        imagesLoaded.classList.add('hidden');
        imagesError.classList.add('hidden');

        try {
            availableImages = await api.get('/api/vms/available-images');

            if (availableImages.length === 0) {
                // Check if GitHub token is configured
                const tokenStatus = await api.get('/api/settings/github-token');

                if (!tokenStatus.configured) {
                    imagesError.className = 'text-sm mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded';
                    imagesError.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2 mt-0.5"></i>
                            <div>
                                <p class="text-yellow-800 font-medium">GitHub token not configured</p>
                                <p class="text-yellow-700 text-xs mt-1">Click the <strong>Settings</strong> button to configure your GitHub personal access token and fetch available images.</p>
                                <p class="text-yellow-700 text-xs mt-1">Or use the <strong>Custom URL</strong> tab to enter an OCI URL manually.</p>
                            </div>
                        </div>
                    `;
                } else {
                    imagesError.className = 'text-sm mt-2 p-3 bg-red-50 border border-red-200 rounded';
                    imagesError.innerHTML = `
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-red-600 mr-2 mt-0.5"></i>
                            <div>
                                <p class="text-red-800 font-medium">Failed to fetch images from GitHub</p>
                                <p class="text-red-700 text-xs mt-1">Your token may be invalid or expired. Please update it in Settings.</p>
                                <p class="text-red-700 text-xs mt-1">Or use the <strong>Custom URL</strong> tab to enter an OCI URL manually.</p>
                            </div>
                        </div>
                    `;
                }

                imagesError.classList.remove('hidden');
                imagesLoading.classList.add('hidden');
                return;
            }

            // Populate image dropdown
            imageSelect.innerHTML = '<option value="">-- Select an image --</option>';
            availableImages.forEach((image, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = image.name;
                imageSelect.appendChild(option);
            });

            imagesLoaded.classList.remove('hidden');
            imagesLoading.classList.add('hidden');
        } catch (error) {
            console.error('Failed to load available images:', error);
            imagesError.className = 'text-sm mt-2 p-3 bg-red-50 border border-red-200 rounded';
            imagesError.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-exclamation-circle text-red-600 mr-2 mt-0.5"></i>
                    <div>
                        <p class="text-red-800 font-medium">Failed to load available images</p>
                        <p class="text-red-700 text-xs mt-1">Please use the <strong>Custom URL</strong> tab to enter an OCI URL manually.</p>
                    </div>
                </div>
            `;
            imagesError.classList.remove('hidden');
            imagesLoading.classList.add('hidden');
        }
    }

    function handleImageSelection() {
        const selectedIndex = imageSelect.value;

        if (!selectedIndex) {
            imageTags.classList.add('hidden');
            imageInfo.classList.add('hidden');
            return;
        }

        const image = availableImages[selectedIndex];

        // Populate tags dropdown
        tagSelect.innerHTML = '';
        if (image.tags && image.tags.length > 0) {
            // Prioritize "latest" tag
            const sortedTags = [...image.tags].sort((a, b) => {
                if (a === 'latest') return -1;
                if (b === 'latest') return 1;
                return a.localeCompare(b);
            });

            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagSelect.appendChild(option);
            });

            imageTags.classList.remove('hidden');
        } else {
            imageTags.classList.add('hidden');
        }

        updateImageUrlPreview();
    }

    function updateImageUrlPreview() {
        const selectedIndex = imageSelect.value;
        if (!selectedIndex) return;

        const image = availableImages[selectedIndex];
        const selectedTag = tagSelect.value || 'latest';

        const fullUrl = `ghcr.io/cirruslabs/${image.name}:${selectedTag}`;
        imageUrlPreview.textContent = fullUrl;
        imageInfo.classList.remove('hidden');
    }

    async function handlePullVm() {
        let ociUrl = '';

        if (currentPullMode === 'select') {
            const selectedIndex = imageSelect.value;
            if (!selectedIndex) {
                showToast('Please select an image', 'error');
                return;
            }

            const image = availableImages[selectedIndex];
            const selectedTag = tagSelect.value || 'latest';
            ociUrl = `ghcr.io/cirruslabs/${image.name}:${selectedTag}`;
        } else {
            ociUrl = ociUrlInput.value.trim();
            if (!ociUrl) {
                showToast('Please enter an OCI URL', 'error');
                return;
            }
        }

        try {
            hideModal(pullVmModal);
            showToast(`Pulling VM image: ${ociUrl}`, 'info');

            const task = await api.post('/api/vms/pull', { oci_url: ociUrl });
            showTaskLogs(task.id, `Pulling VM: ${ociUrl}`);

            // Clear the input
            ociUrlInput.value = '';
            imageSelect.value = '';
            imageTags.classList.add('hidden');
            imageInfo.classList.add('hidden');

        } catch (error) {
            console.error('Error pulling VM:', error);
            showToast(`Failed to pull VM: ${error.message}`, 'error');
        }
    }

    async function loadCreateVmImages() {
        createVmLoading.classList.remove('hidden');
        createVmNoImages.classList.add('hidden');
        createVmImageSelect.innerHTML = '<option value="">-- Select an image --</option>';

        try {
            const data = await api.get('/api/vms/categorized');
            createVmPulledImages = data.base_images || [];

            if (createVmPulledImages.length === 0) {
                createVmNoImages.classList.remove('hidden');
            } else {
                createVmPulledImages.forEach((vm, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = vm.name;
                    createVmImageSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading pulled images:', error);
            createVmImageSelect.innerHTML = '<option value="">Error loading images</option>';
        } finally {
            createVmLoading.classList.add('hidden');
        }
    }

    async function handleCreateVm() {
        const selectedIndex = createVmImageSelect.value;
        if (!selectedIndex) {
            showToast('Please select a base image', 'error');
            return;
        }

        const vmName = createVmNameInput.value.trim();
        const cpu = parseInt(createVmCpuInput.value);
        const memory = parseInt(createVmMemoryInput.value);
        const disk = parseInt(createVmDiskInput.value);

        if (!vmName) {
            showToast('Please enter a VM name', 'error');
            return;
        }

        if (cpu < 1 || cpu > 32) {
            showToast('CPU cores must be between 1 and 32', 'error');
            return;
        }

        if (memory < 1 || memory > 128) {
            showToast('Memory must be between 1 and 128 GB', 'error');
            return;
        }

        if (disk < 10 || disk > 500) {
            showToast('Disk size must be between 10 and 500 GB', 'error');
            return;
        }

        const baseImage = createVmPulledImages[selectedIndex];
        const sourceVmName = baseImage.name;

        try {
            hideModal(createVmModal);
            showToast(`Creating VM: ${vmName} from ${sourceVmName}`, 'info');

            const task = await api.post('/api/vms/create', {
                name: vmName,
                source_vm: sourceVmName,
                cpu: cpu,
                memory: memory,
                disk_size: disk
            });

            showTaskLogs(task.id, `Creating VM: ${vmName}`);
        } catch (error) {
            console.error('Error creating VM:', error);
            showToast(`Failed to create VM: ${error.message}`, 'error');
        }
    }

    function showTaskLogs(taskId, title) {
        currentTaskId = taskId;
        taskTitle.textContent = title;
        taskLogs.innerHTML = '<div class="text-gray-500">Waiting for logs...</div>';
        
        // Connect to WebSocket for real-time logs
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/tasks/${taskId}?token=${encodeURIComponent(window.API_TOKEN || '')}`;
        
        taskSocket = new WebSocket(wsUrl);
        
        taskSocket.onmessage = (event) => {
            // Ignore empty keepalive pings
            if (!event.data || event.data.trim() === '') {
                return;
            }

            const task = JSON.parse(event.data);

            // Update status badge
            let statusClass = 'bg-yellow-100 text-yellow-800';
            if (task.status === 'completed') {
                statusClass = 'bg-green-100 text-green-800';
            } else if (task.status === 'failed') {
                statusClass = 'bg-red-100 text-red-800';
            }

            taskStatus.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}`;
            taskStatus.textContent = task.status.charAt(0).toUpperCase() + task.status.slice(1);

            // Update logs
            if (task.logs && task.logs.length > 0) {
                taskLogs.innerHTML = task.logs.map(log =>
                    `<div class="log-entry">${escapeHtml(log)}</div>`
                ).join('');
                taskLogs.scrollTop = taskLogs.scrollHeight;
            }

            // Close modal if task is completed or failed
            if (task.status === 'completed' || task.status === 'failed') {
                // Auto-close after a delay if successful
                if (task.status === 'completed') {
                    setTimeout(() => {
                        if (taskSocket) {
                            taskSocket.close();
                            taskSocket = null;
                        }
                        hideModal(taskLogsModal);
                        loadVMsCached(); // Refresh VM list (backend already refreshed inventory)
                        refreshActiveTasks(); // Refresh active tasks panel
                    }, 2000);
                }
            }
        };
        
        taskSocket.onclose = () => {
            taskSocket = null;
        };
        
        showModal(taskLogsModal);
    }
    
    // Helper functions
    function showModal(modal) {
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    
    function hideModal(modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
    
    function showLoading() {
        vmsLoading.classList.remove('hidden');
        vmsEmpty.classList.add('hidden');
        baseImagesSection.classList.add('hidden');
        workingVmsSection.classList.add('hidden');
    }

    function hideLoading() {
        vmsLoading.classList.add('hidden');
    }
    
    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        // Set message and style based on type
        toastMessage.textContent = message;
        
        // Reset classes
        toast.className = 'fixed bottom-4 right-4 px-4 py-3 rounded shadow-lg flex items-center';
        
        // Add type-specific classes
        if (type === 'error') {
            toast.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            toast.classList.add('bg-green-100', 'text-green-700');
        } else {
            toast.classList.add('bg-blue-100', 'text-blue-700');
        }
        
        // Show toast
        toast.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 5000);
    }
    
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}
